# Auditor√≠a de Calidad ‚Äî Lumen Salud Mental v2

**Fecha:** 19 de febrero de 2026
**Alcance:** An√°lisis completo del repositorio ‚Äî configuraci√≥n, arquitectura, c√≥digo fuente, seguridad, testing y pr√°cticas.
**Rama auditada:** `main`
**Commit HEAD:** Ver `git log -1` para referencia exacta.

---

## Resumen Ejecutivo

| √Årea | Calificaci√≥n | Detalle |
| --- | --- | --- |
| **Arquitectura** | **B** | Buena separaci√≥n service/context/hooks, pero 5+ hooks rompen la abstracci√≥n accediendo a Firestore directamente |
| **TypeScript** | **B+** | `strict: true`, buen modelado de dominio. 1 error de compilaci√≥n (`usePatients` unused param). 6 usos de `any` |
| **Seguridad** | **D** | Sin RBAC, CSP ineficaz, auto-admin, Turnstile no validado server-side |
| **Testing** | **F** | 6% de archivos con tests, 0% de l√≥gica de negocio, 0% servicios |
| **Performance** | **C+** | Bundle principal de 693KB (sin chunk splitting). 5 listeners Firestore simult√°neos. Stale date window |
| **C√≥digo** | **C+** | Componentes oversized (580-694 l√≠neas), duplicaci√≥n significativa, sin linting |
| **Accesibilidad** | **D** | ModalOverlay sin `role`, sin focus trap, sin Escape key, sin ARIA en modals |
| **DX (Dev Experience)** | **C** | Sin ESLint, sin Prettier, sin `.env.example`, sin `tsc --noEmit` en scripts |

### Score General: **C+**

La aplicaci√≥n funciona y tiene buenas bases arquitect√≥nicas (separaci√≥n de concerns, TypeScript strict, PWA configurada), pero tiene **deudas cr√≠ticas en seguridad** (sin RBAC para datos cl√≠nicos), **cobertura de tests pr√°cticamente nula**, y **duplicaci√≥n significativa** que incrementa el riesgo de bugs. Las prioridades inmediatas son seguridad y testing ‚Äî el resto es deuda t√©cnica manejable.

---

## 1. HALLAZGOS CR√çTICOS (Acci√≥n Inmediata)

### SEC-01 ‚Äî Sin Control de Acceso por Rol en Firestore

**Archivo:** `firestore.rules`
Cualquier usuario autenticado puede leer/escribir **todos** los datos cl√≠nicos. La restricci√≥n por `professionalName` es solo query-level en el cliente (bypasseable). Para una app de salud mental, este es el mayor riesgo de compliance.

### SEC-02 ‚Äî Auto-Admin en Primer Login

**Archivo:** `src/views/AuthScreen.tsx`
Todo usuario nuevo recibe `role: 'admin'` hardcodeado. Combinado con SEC-01, cualquier persona con credenciales Firebase tiene acceso total a todos los registros cl√≠nicos.

```tsx
// L√≠nea ~59 en AuthScreen.tsx ‚Äî PROBLEM√ÅTICO
await setDoc(userRef, {
    email: user.email,
    displayName: user.displayName || 'Profesional Lumen',
    role: 'admin',  // <-- HARDCODEADO
    settings: { notifications: true }
});
```

### SEC-03 ‚Äî Turnstile Token No Validado en Servidor

**Archivo:** `src/views/AuthScreen.tsx`
El token de Cloudflare Turnstile se chequea solo en el cliente (`if (!turnstileToken)`). Un atacante puede llamar `signInWithEmailAndPassword` directamente, bypaseando el CAPTCHA por completo.

### SEC-04 ‚Äî CSP con `unsafe-inline` + `unsafe-eval`

**Archivo:** `firebase.json`
La Content Security Policy incluye `'unsafe-inline'` y `'unsafe-eval'`, anulando la protecci√≥n contra XSS. Adem√°s whitelistea `cdn.tailwindcss.com` (solo usado en dev) y `aistudiocdn.com` en producci√≥n ‚Äî superficie de ataque innecesaria.

### LINT-01 ‚Äî Sin ESLint ni Linting de Ning√∫n Tipo

**Archivos:** Ra√≠z del proyecto (`.eslintrc` inexistente)
Cero an√°lisis est√°tico m√°s all√° del compilador TS. Sin detecci√≥n de floating promises, reglas de hooks (`react-hooks/rules-of-hooks`), unused expressions, o patrones peligrosos.

### TSC-01 ‚Äî Sin `tsc --noEmit` en Pipeline de Build

El build de Vite **no ejecuta** TypeScript compiler checks. Errores de tipo pueden llegar a producci√≥n. Actualmente existe 1 error confirmado:

```bash
src/hooks/usePatients.ts(4,29): error TS6133: 'user' is declared but its value is never read.
```

### BUILD-01 ‚Äî Bundle Principal de 693KB sin Code Splitting

**Archivo:** `vite.config.ts`
El chunk `index-yMqX1Az2.js` pesa 693KB (178KB gzipped). Firebase SDK, React, y todo el c√≥digo de la app est√°n en un √∫nico archivo. Vite emite advertencia `"Some chunks are larger than 500 kB after minification"`. No hay `manualChunks` configurado.

### A11Y-01 ‚Äî Modals Sin Accesibilidad

**Archivo:** `src/components/ui/index.tsx` ‚Äî `ModalOverlay`
Carece de: `role="dialog"`, `aria-modal`, focus trapping, manejo de tecla Escape, y `aria-label`. Afecta **todos** los modals de la aplicaci√≥n. Screen readers y usuarios de teclado no pueden interactuar.

### ARCH-01 ‚Äî Hooks que Bypasean `IDataService`

5 hooks + 2 componentes acceden a Firestore directamente, rompiendo la abstracci√≥n del service layer:

| Archivo | Colecciones accedidas |
| --- | --- |
| `src/hooks/useClinicalNotes.ts` | `notes` |
| `src/hooks/usePendingTasks.ts` | `notes` |
| `src/hooks/usePsiquePayments.ts` | `psiquePayments` |
| `src/hooks/usePatientData.ts` | `appointments`, `payments` |
| `src/hooks/useStaff.ts` | `staff` |
| `src/views/TasksView.tsx` | `notes` (writes directos) |
| `src/components/modals/AddTaskModal.tsx` | `notes` (writes directos) |

### HOOK-01 ‚Äî Violaci√≥n de Rules of Hooks en `useClinicalNotes`

**Archivo:** `src/hooks/useClinicalNotes.ts`
`useClinicalNote` y `usePatientNotes` son hooks React definidos como closures **dentro** de `useClinicalNotes`. Esto viola las [Rules of Hooks](https://react.dev/reference/rules/rules-of-hooks) ‚Äî React no puede detectar cambios en el orden de llamadas, pudiendo resultar en estado stale o crashes silenciosos.

### DATA-01 ‚Äî Ventana de Datos Est√°tica (Stale Date Window)

**Archivo:** `src/context/DataContext.tsx`
La ventana de suscripci√≥n (-3 a +6 meses) se calcula **una sola vez** al montar el contexto. Si la app PWA queda abierta y no se recarga, los datos se vuelven stale al cruzar l√≠mites de fecha sin que el usuario lo note.

### TEST-01 ‚Äî Cobertura de Tests Pr√°cticamente Nula

Solo 7 unit tests (2 funciones utilitarias) y 3 tests E2E b√°sicos. **Zero tests** para: `FirebaseService` (15+ m√©todos), l√≥gica financiera, billing, clinical notes, o cualquier hook de negocio.

---

## 2. CONFIGURACI√ìN Y TOOLING

### package.json

| Severidad | Hallazgo |
| --- | --- |
| **Critical** | Sin `lint` script ‚Äî sin ESLint configurado |
| **Critical** | Sin `tsc --noEmit` ‚Äî errores de tipo pueden llegar a producci√≥n |
| **Important** | Sin Prettier ni `.prettierrc` |
| **Important** | `version: "0.0.0"` ‚Äî no sigue semver |
| **Important** | Sin script `ci` compuesto (`type-check && lint && test && build`) |
| **Minor** | Firebase SDK `^10.8.0` ‚Äî v11.x disponible con mejoras de bundle |
| **Minor** | Sin campo `engines` para fijar versi√≥n de Node |

### tsconfig.json

| Severidad | Hallazgo |
| --- | --- |
| **Important** | Sin path aliases (`@/`) ‚Äî imports con rutas relativas largas |
| **Important** | `noUncheckedIndexedAccess` no habilitado ‚Äî `array[i]` retorna `T` en vez de `T \| undefined` |
| **Minor** | `exactOptionalPropertyTypes` no habilitado |
| **Minor** | `vitest.config.ts` y `playwright.config.ts` no incluidos en `tsconfig.node.json` |

### vite.config.ts

| Severidad | Hallazgo |
| --- | --- |
| **Important** | Sin `build.rollupOptions.output.manualChunks` ‚Äî Firebase SDK debe separarse |
| **Important** | Sin `build.sourcemap: 'hidden'` para error tracking en producci√≥n |
| **Important** | Sin caching de Firestore API en Workbox |
| **Minor** | Sin `build.target` expl√≠cito |

### tailwind.config.js

| Severidad | Hallazgo |
| --- | --- |
| **Important** | Sin tokens sem√°nticos ‚Äî `teal-600` hardcodeado en toda la app en vez de `brand.primary` |
| **Minor** | Sin `darkMode` expl√≠cito |
| **Minor** | TailwindCSS v3.4.x ‚Äî v4 disponible (migraci√≥n mayor) |

### vitest.config.ts

| Severidad | Hallazgo |
| --- | --- |
| **Important** | Sin configuraci√≥n de cobertura (`coverage`, `thresholds`) |
| **Important** | `plugins: [react()] as any` ‚Äî cast oculta posibles incompatibilidades |
| **Minor** | Sin `restoreMocks: true` |
| **Minor** | Sin `testTimeout` expl√≠cito |

### playwright.config.ts

| Severidad | Hallazgo |
| --- | --- |
| **Important** | Solo Chromium configurado ‚Äî sin Firefox ni WebKit (Safari users) |
| **Important** | `reuseExistingServer: false` siempre ‚Äî lento en desarrollo local |
| **Minor** | Sin `screenshot: 'only-on-failure'` |

### firebase.json

| Severidad | Hallazgo |
| --- | --- |
| **Critical** | CSP con `'unsafe-inline'` + `'unsafe-eval'` |
| **Important** | CDNs de desarrollo en CSP de producci√≥n (`cdn.tailwindcss.com`) |
| **Important** | Sin caching headers para assets con hash (`Cache-Control: immutable`) |
| **Important** | `index.html` deber√≠a tener `Cache-Control: no-cache` |

### index.html

| Severidad | Hallazgo |
| --- | --- |
| **Critical** | `window.__firebase_config` y `window.__app_id` con valores mock hardcodeados en HTML de producci√≥n |
| **Important** | Sin preconnect hints (`firestore.googleapis.com`, `fonts.googleapis.com`) |
| **Minor** | Favicon: MIME type `image/png` para archivo `.ico` |
| **Minor** | Title "Lumen App" ‚â† manifest name "Lumen Salud Mental" |
| **Minor** | Sin `<noscript>` fallback |

### Archivos Faltantes

| Archivo | Severidad |
| --- | --- |
| `.env.example` | **Important** ‚Äî developers no saben qu√© variables configurar |
| `.eslintrc` / `eslint.config.*` | **Critical** |
| `.prettierrc` | **Important** |
| `playwright-report/` en `.gitignore` | **Minor** ‚Äî artifacts generados commiteados |
| `test-results/` en `.gitignore` | **Minor** ‚Äî artifacts generados commiteados |

---

## 3. TIPOS Y CAPA DE DATOS

### Types (`src/types/index.ts`)

| ID | Severidad | Hallazgo |
| --- | --- | --- |
| T1 | **Important** | 6 usos de `any`: `usePendingTasks` (createdAt), `Sidebar` (SidebarItem props), `DashboardView` (appointment param, icon prop), `AuthScreen` (catch err), `AppointmentModal` (select value) |
| T2 | **Important** | `Payment.date` es `Timestamp \| null` pero `FirebaseService.addPayment` descarta silenciosamente el valor pasado y escribe `Timestamp.now()` ‚Äî violaci√≥n del contrato de tipo |
| T3 | **Important** | `ClinicalNote` no tiene m√©todos en `IDataService` ni tipo `ClinicalNoteInput` ‚Äî rompe el patr√≥n arquitect√≥nico |
| T4 | **Important** | `PsiquePayment` tampoco est√° en `IDataService` |
| T5 | **Minor** | `StaffProfile.createdAt: Timestamp \| ReturnType<typeof serverTimestamp>` mezcla tipos de lectura y escritura |
| T6 | **Minor** | `BillingLineItem` definido en types pero no referenciado desde la interface de service |
| T7 | **Minor** | `Patient.name` ambiguo ‚Äî "Computed or full name" pero `firstName`/`lastName` son opcionales sin l√≥gica de derivaci√≥n |

### IDataService (`src/services/IDataService.ts`)

| ID | Severidad | Hallazgo |
| --- | --- | --- |
| S1 | **Critical** | Interface incompleta ‚Äî clinical notes, tasks, psique, patient history, y staff operan fuera de la abstracci√≥n |
| S2 | **Minor** | `subscribeToFinance` toma 2 callbacks pero DataContext pasa `() => {}` para el primero ‚Äî suscripci√≥n innecesaria |
| S3 | **Important** | `deletePayment` existe en interface pero Firestore rules lo bloquean siempre (`allow delete: if false`) |

### FirebaseService (`src/services/FirebaseService.ts`)

| ID | Severidad | Hallazgo |
| --- | --- | --- |
| S4 | **Important** | Sin error typing ni wrapping ‚Äî errores de Firebase crudos llegan a consumidores sin normalizaci√≥n |
| S5 | **Important** | Batch writes sin enforcer l√≠mite de 500 ops ‚Äî recurrencias largas pueden excederlo silenciosamente |
| S6 | **Important** | `addPayment` descarta el `date` del input y escribe `Timestamp.now()` |
| S7 | **Minor** | `subscribeToPatients` sin filtro cuando `professionalName` es null ‚Äî no documentado |
| S8 | **Important** | `requestBatchInvoice` no actualiza `billingStatus` en appointments de forma at√≥mica |
| S9 | **Minor** | `deleteRecurringFromDate` trae toda la serie y filtra client-side en vez de usar compound query |

### DataContext (`src/context/DataContext.tsx`)

| ID | Severidad | Hallazgo |
| --- | --- | --- |
| C1 | **Critical** | Ventana de fechas calculada una vez, nunca se recalcula (stale en sesiones largas) |
| C2 | **Important** | 5 listeners Firestore simult√°neos al montar ‚Äî `allAppointments` siempre activo aunque solo se use en vista "Todos" |
| C3 | **Important** | `loading` solo controlado por `subscribeToMyAppointments` ‚Äî las otras 3 suscripciones no participan |
| C4 | **Minor** | Cada snapshot crea nuevo array ‚Üí re-renders en todos los consumidores ante cualquier cambio Firestore |
| C5 | **Minor** | Callback `onUnpaid` pasa `() => {}` ‚Äî query ejecutada, datos descartados |

---

## 4. HOOKS

| Archivo | Severidad | Hallazgo principal |
| --- | --- | --- |
| `useClinicalNotes.ts` | **Critical** | Hooks anidados dentro de hook factory ‚Äî violaci√≥n Rules of Hooks |
| `useDataActions.ts` | **Important** | Sin memoizaci√≥n del objeto retornado ‚Äî nuevas refs en cada render |
| `usePatientData.ts` | **Important** | `isOverdue` con l√≥gica diferente al resto de la app (date-only vs 1hr-after-start) |
| `usePatients.ts` | **Important** | Wrapper in√∫til que ignora el par√°metro `User` ‚Äî deber√≠a eliminarse |
| `usePendingTasks.ts` | **Important** | Re-suscribe en cada cambio de `appointments` (deber√≠a usar ref). Full scan de colecci√≥n `notes` |
| `useStaff.ts` | **Important** | `createProfile`/`updateProfile` sin memoizaci√≥n |
| `usePatientData.ts` | **Important** | Dos Firestore listeners sin estado de loading unificado |
| `useAgendaStats.ts` | **Minor** | Bien estructurado, `useMemo` correcto |
| `useBillingStatus.ts` | **Minor** | Limpio, cleanup correcto |
| `useCalendarAppointments.ts` | **Minor** | M√≠nimo y correcto |
| `usePsiquePayments.ts` | **Minor** | `useMemo` correcto, suscripci√≥n bien scoped |

---

## 5. COMPONENTES Y VISTAS

### Componentes Cr√≠ticos

| Archivo | L√≠neas | Severidad | Problema |
| --- | --- | --- | --- |
| `AppointmentDetailsModal.tsx` | 694 | **Critical** | Demasiado grande ‚Äî notas cl√≠nicas, confirmaciones de borrado, cancelaci√≥n deber√≠an ser componentes separados |
| `TasksView.tsx` | 672 | **Critical** | Modals inline, lista, filtros, y writes directos a Firestore todo junto |
| `CalendarView.tsx` | ~580 | **Critical** | WeekView, MonthView, AppointmentCard, TimeIndicator deber√≠an separarse |
| `PatientModal.tsx` | 501 | **Important** | Form state podr√≠a extraerse a `usePatientForm` hook |
| `PaymentsView.tsx` | 548 | **Important** | 5 modos de vista deber√≠an ser sub-componentes |

### Problemas Recurrentes en Componentes

| Patr√≥n | Severidad | Archivos afectados |
| --- | --- | --- |
| `confirm()` nativo mezclado con dialogs custom | **Important** | `AppointmentDetailsModal`, `PatientsView` |
| `ModalOverlay` no usado consistentemente | **Important** | `ProfileModal`, `TasksView` usan overlay propio |
| Props `user` aceptadas pero no usadas | **Important** | `AppointmentModal` (user prop ignorada) |
| Computaciones pesadas no memoizadas | **Important** | `hasPendingDebts` en Sidebar, `movements` en PatientProfileModal |
| `window.innerWidth` le√≠do durante render | **Important** | `CalendarView.getHourHeight()` |
| `usePatientData` activa 2 listeners por modal | **Important** | `PatientProfileModal` |
| `PWAUpdatePrompt` interval no limpiado | **Important** | `PWAUpdatePrompt.tsx` |
| `onKeyPress` deprecated | **Minor** | `TasksView.tsx` |
| `aria-sort` faltante en headers de tabla | **Minor** | `PatientTable.tsx` |
| `SidebarItem` tipado como `any` | **Important** | `Sidebar.tsx` |
| Mobile menu falta "Estad√≠sticas" vs Sidebar desktop | **Minor** | `MobileHeader.tsx` |

### App.tsx

| Severidad | Hallazgo |
| --- | --- |
| **Important** | Sin `ErrorBoundary` alrededor de Suspense ‚Äî chunk fail = crash silencioso |
| **Important** | Prop drilling de `user`/`profile` a todas las vistas |
| **Important** | `selectedPatientId`/`patientHistoryInitialTab` como estado de navegaci√≥n en App ‚Äî implicit routing state |
| **Minor** | `Toaster` (sonner) solo en rama autenticada ‚Äî errores de login no tienen toast |
| **Minor** | Sin sincronizaci√≥n con URL ‚Äî refresh siempre regresa al dashboard |
| **Minor** | Lazy imports con `.then(module => ({ default: module.ComponentName }))` boilerplate innecesario |

---

## 6. SEGURIDAD

| ID | Severidad | Hallazgo | Archivo |
| --- | --- | --- | --- |
| SEC-01 | **Critical** | Sin RBAC ‚Äî cualquier usuario autenticado lee/escribe todo | `firestore.rules` |
| SEC-02 | **Critical** | Auto-admin en primer login | `AuthScreen.tsx` |
| SEC-03 | **Critical** | Turnstile validado solo client-side | `AuthScreen.tsx` |
| SEC-04 | **Critical** | CSP con `unsafe-inline` + `unsafe-eval` | `firebase.json` |
| SEC-05 | **High** | Staff profiles editables por cualquier autenticado (escalada de privilegios) | `firestore.rules` |
| SEC-06 | **High** | Sin validaci√≥n de schema en Firestore rules | `firestore.rules` |
| SEC-07 | **High** | Storage sin l√≠mites de tama√±o ni tipo de archivo | `storage.rules` |
| SEC-08 | **High** | Cloud Function sin validaci√≥n de input, errores internos en Firestore | `functions/src/index.ts` |
| SEC-09 | **High** | Perfil de usuario escrito a path sin regla Firestore ‚Äî silently fails | `AuthScreen.tsx` |
| SEC-10 | **Medium** | Sin audit trail para acceso a datos de salud (HIPAA concern) | ‚Äî |
| SEC-11 | **Medium** | Sin session timeout ‚Äî Firebase Auth persiste indefinidamente | ‚Äî |
| SEC-12 | **Medium** | Email guardado en `localStorage` en plaintext | `AuthScreen.tsx` |
| SEC-13 | **Medium** | Mensajes de error Firebase mostrados directamente al usuario | `AuthScreen.tsx` |
| SEC-14 | **Low** | Mock Firebase config hardcodeado en `index.html` de producci√≥n | `index.html` |
| SEC-15 | **Low** | Sin `dangerouslySetInnerHTML` ‚Äî React escaping activo (positivo) | Toda la app |

---

## 7. TESTING

### Estado Actual

| M√©trica | Valor |
| --- | --- |
| Archivos fuente | ~35 |
| Archivos con tests | 2 (6%) |
| Unit test assertions | 7 |
| E2E test scenarios | 3 |
| Cobertura de l√≥gica de negocio | **0%** |
| Cobertura de c√°lculos financieros | **0%** |
| Cobertura del service layer | **0%** |
| Cobertura de hooks | **0%** |

### Archivos Sin Tests ‚Äî Ordenados por Riesgo

#### Riesgo Cr√≠tico (l√≥gica financiera/datos)

1. `src/services/FirebaseService.ts` ‚Äî 15+ m√©todos CRUD sin ning√∫n test
2. `src/hooks/usePsiquePayments.ts` ‚Äî c√°lculo del 25% de fee con impacto de billing real
3. `src/hooks/useAgendaStats.ts` ‚Äî agregaciones estad√≠sticas usadas en decisiones de negocio
4. `src/views/PaymentsView.tsx` ‚Äî l√≥gica `isOverdue`, `PSIQUE_RATE`, filtrado por mes
5. `src/hooks/useBillingStatus.ts` ‚Äî registros facturados bloqueados por Firestore rules
6. `src/hooks/useDataActions.ts` ‚Äî wrapper de todas las mutaciones
7. `functions/src/index.ts` ‚Äî Cloud Function de billing

#### Riesgo Alto (acceso a datos/reglas de negocio)

1. `src/context/DataContext.tsx`
2. `src/context/ServiceContext.tsx`
3. `src/hooks/useClinicalNotes.ts`
4. `src/hooks/usePendingTasks.ts`
5. `src/views/BillingView.tsx`

---

## 8. DUPLICACI√ìN DE C√ìDIGO

| Patr√≥n | Ocurrencias | Severidad | Soluci√≥n |
| --- | --- | --- | --- |
| `calculateAge()` | 4 archivos (con variaci√≥n de firma) | **High** | Centralizar en `src/lib/utils.ts` |
| `PSIQUE_RATE = 0.25` | 4 archivos + 6+ strings "25%" en UI | **High** | Centralizar en `src/lib/constants.ts` |
| Collection paths inline vs `routes.ts` | 8+ archivos | **High** | Agregar `notes`, `staff`, `psiquePayments`, `users` a `routes.ts` |
| `toLocaleDateString()` con locales mixtos | 10+ variantes inline (`es-AR` vs `es-ES` vs default) | **Medium** | Helpers `formatDateShort`, `formatDateLong` en utils |
| `isOverdue()` l√≥gica | 3 archivos con l√≥gica diferente | **Medium** | Centralizar en utils con definici√≥n √∫nica |
| Firestore writes directos en views | `TasksView`, `AddTaskModal` | **Medium** | Mover a `IDataService`/`FirebaseService` |

---

## 9. M√âTRICAS DE BUILD

```bash
vite v5.4.21 building for production...
‚úì 1531 modules transformed

dist/assets/index-yMqX1Az2.js    692.54 kB ‚îÇ gzip: 177.72 kB  ‚ö†Ô∏è EXCEDE 500KB
dist/assets/CalendarView-...js    40.41 kB ‚îÇ gzip:  10.75 kB
dist/assets/PaymentsView-...js    25.23 kB ‚îÇ gzip:   6.07 kB
dist/assets/PatientsView-...js    22.27 kB ‚îÇ gzip:   5.48 kB
dist/assets/index-...css          39.65 kB ‚îÇ gzip:   7.08 kB

PWA precache: 45 entries (1655.71 KiB)
Build time: 4.58s
TS errors (tsc --noEmit): 1
Unit tests passing: 7/7
```

---

## 10. PLAN DE ACCI√ìN RECOMENDADO

### Fase 1 ‚Äî Seguridad (Semanas 1-2) üî¥

1. Implementar RBAC en Firestore rules (role checks, professional scoping)
2. Eliminar auto-admin ‚Äî agregar flujo de invitaci√≥n/aprobaci√≥n o verificaci√≥n manual
3. Limpiar CSP: remover `unsafe-eval`, `unsafe-inline`, CDNs innecesarias
4. Agregar validaci√≥n server-side de Turnstile en Cloud Function
5. Agregar validaci√≥n de schema en Firestore rules (campos requeridos, tipos)
6. Limitar storage (tama√±o m√°ximo, MIME types permitidos)
7. Validar input en Cloud Function `triggerInvoiceGeneration`
8. Agregar regla Firestore para path `users/{uid}` (actualmente bloqueado por catch-all)

### Fase 2 ‚Äî Estabilidad y DX (Semanas 3-4) üü†

1. Agregar `ErrorBoundary` global con UI de retry alrededor del √°rbol de Suspense
2. Fix date window stale en `DataContext` (visibility listener + rec√°lculo peri√≥dico)
3. Agregar `"type-check": "tsc --noEmit"` a `package.json` scripts
4. Instalar y configurar ESLint + `@typescript-eslint` + `eslint-plugin-react-hooks`
5. Configurar Prettier + `.prettierrc`
6. Crear `.env.example` con todas las variables necesarias
7. Agregar `playwright-report/` y `test-results/` al `.gitignore`

### Fase 3 ‚Äî Testing (Semanas 5-7) üü°

1. Tests unitarios para `FirebaseService` (mock Firestore con `firebase-admin` o `@firebase/rules-unit-testing`)
2. Tests para l√≥gica financiera cr√≠tica (`usePsiquePayments`, `useAgendaStats`)
3. Tests para billing workflow y status transitions
4. Tests para hooks con mocked Context
5. Configurar Vitest coverage con thresholds m√≠nimos (`branches: 70, functions: 80`)
6. Ampliar E2E: flujo de agendamiento, creaci√≥n de paciente, pago

### Fase 4 ‚Äî Refactoring (Semanas 8-10) üü¢

1. Centralizar `calculateAge`, `PSIQUE_RATE`, `isOverdue`, date utils
2. Completar `routes.ts` con todas las colecciones y usarla en los hooks directos
3. Mover clinical notes, tasks, psique, staff a `IDataService`/`FirebaseService`
4. Fix `useClinicalNotes` ‚Äî extraer hooks internos como funciones separadas (Top-Level)
5. Memoizar `useDataActions` y funciones en `useStaff`, `useClinicalNotes`
6. Agregar accesibilidad a `ModalOverlay` (role, aria-modal, focus trap, Escape)
7. Descomponer componentes grandes: `CalendarView` ‚Üí WeekView/MonthView; `TasksView` ‚Üí TaskList + modals; `AppointmentDetailsModal` ‚Üí separar secci√≥n de notas y dialogs
8. Eliminar prop drilling con Context para `user`/`profile`

### Fase 5 ‚Äî Performance y Polish (Semana 11-12) üîµ

1. Configurar `manualChunks` en Vite (`firebase`, `react`/`react-dom`, `vendor`)
2. Agregar caching headers en Firebase Hosting (`immutable` para assets con hash)
3. Path aliases (`@/`) en tsconfig + Vite
4. Tokens sem√°nticos de color en Tailwind (`brand.primary`, `brand.secondary`)
5. Source maps ocultas (`sourcemap: 'hidden'`) para error tracking
6. Agregar Firefox/WebKit a Playwright
7. `noUncheckedIndexedAccess` en tsconfig

---

#### *Auditor√≠a realizada por GitHub Copilot (Claude Sonnet 4.6) ‚Äî 19 de febrero de 2026*

---

## Planes generados a partir de esta auditor√≠a

| Plan | Hallazgos abordados | Estado |
| --- | --- | --- |
| [Phase 1: Security ‚Äî Plan principal](../plans/2026-02-19-phase1-security.md) | SEC-01, SEC-02, SEC-03, SEC-04 | Ejecutado ‚úì |
| [Phase 1: Security ‚Äî Fixes post code-review](../plans/2026-02-19-phase1-security-fixes.md) | SEC-03 (secrets), staff rules, firebase-admin, getFunctions | Ejecutado ‚úì |
| [Phase 2: Estabilidad, DX y Arquitectura](../plans/2026-02-22-phase2-stability-dx-architecture.md) | LINT-01, TSC-01, ARCH-01, HOOK-01, TEST-01 | Ejecutado ‚úì |
| [Phase 2: Fixes post-evaluaci√≥n](../plans/2026-02-23-phase2-fixes.md) | ARCH-01 (TasksView), LINT-01 (regex), TEST-01 (coverage) | Ejecutado ‚úì |

‚Üí Revisi√≥n de cierre Phase 1: [2026-02-22_phase1-completion-review.md](../reviews/2026-02-22_phase1-completion-review.md)

‚Üí Revisi√≥n de cierre Phase 2: [2026-02-23_phase2-completion-review.md](../reviews/2026-02-23_phase2-completion-review.md)

‚Üí √çndice general: [docs/README.md](../README.md)
