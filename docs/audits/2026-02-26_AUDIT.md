# Auditoría de Calidad — Lumen Salud Mental v2 (Post-4 Fases)

**Fecha:** 26 de febrero de 2026
**Alcance:** Verificación de resolución de hallazgos de la auditoría del 19/02/2026 + evaluación del estado actual del repositorio.
**Auditoría de referencia:** [`docs/audits/2026-02-19_AUDIT.md`](2026-02-19_AUDIT.md)
**Fases ejecutadas:** 4 ciclos completos (Seguridad → Estabilidad/DX → Testing → Performance/A11y/Services)

---

## Resumen Ejecutivo

| Área              | Antes (19/02) | Ahora (26/02) | Cambio                                                                |
| ----------------- | ------------- | ------------- | --------------------------------------------------------------------- |
| **Seguridad**     | **D**         | **B**         | ↑↑↑ RBAC implementado, CSP limpia, Turnstile server-side, allowlist   |
| **Arquitectura**  | **B**         | **B+**        | ↑ Service layer completo, hooks migrados, ErrorBoundary               |
| **TypeScript**    | **B+**        | **A-**        | ↑ 0 errores `tsc`, ESLint configurado, strict mode verificado         |
| **Testing**       | **F**         | **B-**        | ↑↑↑↑ 92 tests, 6 archivos, coverage 89.83% en scope                   |
| **Performance**   | **C+**        | **A-**        | ↑↑ Bundle principal de 29.65KB (era 693KB), chunks separados          |
| **Código**        | **C+**        | **B**         | ↑ Hooks refactorizados, pero componentes grandes persisten            |
| **Accesibilidad** | **D**         | **B+**        | ↑↑↑ ModalOverlay con ARIA/focus trap/Escape completo                  |
| **DX**            | **C**         | **A-**        | ↑↑ ESLint, Prettier, `.env.example`, script `ci`, coverage thresholds |

### Score General: **B+** (era C+)

El proyecto mejoró significativamente en todas las áreas críticas. Los 12 hallazgos de la auditoría original están resueltos o en estado aceptable. La deuda técnica restante es de severidad media-baja y no representa riesgo operativo inmediato.

---

## 1. VERIFICACIÓN DE HALLAZGOS PREVIOS

### Hallazgos Críticos — Todos Resueltos ✓

| ID           | Hallazgo Original                            | Estado       | Fase      | Evidencia                                                                                                                                                                                                                                        |
| ------------ | -------------------------------------------- | ------------ | --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **SEC-01**   | Sin RBAC en Firestore                        | **RESUELTO** | Fase 1    | `firestore.rules` con `isAdmin()`, `getProfessionalName()`, scoping por profesional en cada colección                                                                                                                                            |
| **SEC-02**   | Auto-admin en primer login                   | **RESUELTO** | Fase 1    | Flujo allowlist: check `staff/{uid}` → check `allowedEmails/{email}` → sign out si no autorizado                                                                                                                                                 |
| **SEC-03**   | Turnstile no validado server-side            | **RESUELTO** | Fase 1    | Cloud Function `validateTurnstile` con secret de Cloud Secret Manager, llamada antes de `signInWithEmailAndPassword`                                                                                                                             |
| **SEC-04**   | CSP con `unsafe-inline` + `unsafe-eval`      | **RESUELTO** | Fase 1    | `unsafe-eval` eliminado; `unsafe-inline` solo en `style-src` (requerido por Tailwind). CDNs innecesarias removidas                                                                                                                               |
| **LINT-01**  | Sin ESLint                                   | **RESUELTO** | Fase 2    | ESLint 9 flat config con `@typescript-eslint`, `react-hooks`, `react-refresh`, `eslint-config-prettier`                                                                                                                                          |
| **TSC-01**   | Sin `tsc --noEmit` en pipeline               | **RESUELTO** | Fase 2    | Script `type-check` + script `ci` encadenado. 0 errores actualmente                                                                                                                                                                              |
| **BUILD-01** | Bundle 693KB sin code splitting              | **RESUELTO** | Fase 4    | `manualChunks`: chunk principal 29.65KB, `vendor-firebase` 498KB, `vendor-ui` 192KB                                                                                                                                                              |
| **A11Y-01**  | Modals sin accesibilidad                     | **RESUELTO** | Fase 4    | `role="dialog"`, `aria-modal`, `aria-label`, focus trap Tab/Shift+Tab, Escape, save/restore focus                                                                                                                                                |
| **ARCH-01**  | Hooks bypasean IDataService                  | **PARCIAL**  | Fases 2-4 | Casi todos los hooks migrados a `useService()`. **Excepción:** `useStaff` importa `serverTimestamp` directamente de `firebase/firestore`, violando la abstracción (ver HOOK-N02). Se da por completado funcionalmente, pero no es 100% resuelto. |
| **HOOK-01**  | Violación Rules of Hooks en useClinicalNotes | **RESUELTO** | Fase 2    | Hooks separados en funciones top-level                                                                                                                                                                                                           |
| **DATA-01**  | Ventana de datos estática (stale)            | **RESUELTO** | Fase 4    | `getDateWindow()` + `visibilitychange` listener + intervalo 4h                                                                                                                                                                                   |
| **TEST-01**  | Cobertura de tests nula (6%)                 | **RESUELTO** | Fases 2-4 | 92 tests, 6 archivos, coverage scope 89.83% stmts                                                                                                                                                                                                |

### Hallazgos Secundarios — Estado Mixto

| ID         | Hallazgo Original                        | Estado          | Detalle                                                                                    |
| ---------- | ---------------------------------------- | --------------- | ------------------------------------------------------------------------------------------ |
| **SEC-05** | Staff profiles editables por cualquiera  | **RESUELTO**    | Rules ahora restringen por admin/propio usuario                                            |
| **SEC-06** | Sin schema validation en Firestore rules | **NO RESUELTO** | No se validar tipos ni campos requeridos en rules                                          |
| **SEC-07** | Storage sin límites de tamaño/tipo       | **NO RESUELTO** | `storage.rules` solo verifica `request.auth != null`                                       |
| **SEC-08** | Cloud Function sin validación input      | **PARCIAL**     | `validateTurnstile` OK; `triggerInvoiceGeneration` hace `...data` spread sin sanitizar     |
| **SEC-09** | Path de users sin regla Firestore        | **RESUELTO**    | Eliminado; onboarding escribe a `staff` con regla                                          |
| **SEC-10** | Sin audit trail                          | **NO RESUELTO** | Sin registro de acceso a datos clínicos                                                    |
| **SEC-11** | Sin session timeout                      | **NO RESUELTO** | Firebase Auth persiste indefinidamente                                                     |
| **SEC-12** | Email en localStorage plaintext          | **ACEPTABLE**   | Patrón estándar de "remember me" — riesgo bajo para app clínica con dispositivos dedicados |
| **SEC-13** | Mensajes de error Firebase crudos        | **PARCIAL**     | Custom para Turnstile y allowlist; catch general aún expone `err.message`                  |
| **SEC-14** | Mock config en index.html                | **RESUELTO**    | Config ahora solo via `import.meta.env`                                                    |

---

## 2. VERIFICACIÓN TÉCNICA (26/02/2026)

| Check               | Resultado                                                       |
| ------------------- | --------------------------------------------------------------- |
| `npx tsc --noEmit`  | ✅ 0 errores                                                    |
| `npx eslint src/`   | ✅ 0 errores, 11 warnings (`no-explicit-any`)                   |
| `npm test -- --run` | ✅ 92 tests, 6 archivos, todos pasan                            |
| `npm run build`     | ✅ Build exitoso sin warnings de chunk size                     |
| Coverage            | ✅ Stmts 89.83%, Branches 79.01%, Functions 82.6%, Lines 91.01% |

### Métricas de Build

| Chunk                 | Tamaño      | gzip      |
| --------------------- | ----------- | --------- |
| `vendor-firebase`     | 498.50 KB   | 116.34 KB |
| `vendor-ui`           | 192.51 KB   | 58.05 KB  |
| `index` (app code)    | 29.65 KB    | 9.68 KB   |
| `CalendarView` (lazy) | 39.57 KB    | 10.30 KB  |
| `PaymentsView` (lazy) | 24.84 KB    | 5.82 KB   |
| `PatientsView` (lazy) | 21.29 KB    | 5.15 KB   |
| Resto (lazy views)    | 1-14 KB c/u | —         |
| CSS total             | 40.38 KB    | 7.19 KB   |

### Métricas de Testing

| Métrica         | Antes (19/02)       | Ahora (26/02)                               |
| --------------- | ------------------- | ------------------------------------------- |
| Test files      | 2                   | 6                                           |
| Total tests     | 7                   | 92                                          |
| Coverage scope  | 0% negocio          | 89.83% stmts en scope                       |
| Áreas testeadas | utils (2 funciones) | utils, psiqueCalcs, hooks (2), services (2) |
| E2E tests       | 3 (auth only)       | 3 (auth only)                               |

---

## 3. HALLAZGOS NUEVOS

### 3.1 Seguridad

| ID          | Severidad | Hallazgo                                                                                                                                                                                                   | Archivo                      |
| ----------- | --------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------- |
| **SEC-N01** | **Alta**  | `psiquePayments` abierto a cualquier usuario autenticado sin RBAC ni scoping por profesional. Las reglas solo exigen `isAuthenticated()` mientras que el resto de colecciones exige `isAdmin()` o scoping. | `firestore.rules` L79        |
| **SEC-N02** | **Media** | `triggerInvoiceGeneration` hace spread `...data` al webhook de n8n sin sanitizar campos. Un campo inyectado en el `create` del billing queue se reenvía al webhook.                                        | `functions/src/index.ts` L70 |
| **SEC-N03** | **Media** | `validateTurnstile` sin rate limiting ni App Check. Ataques masivos podrían consumir quota de Cloudflare.                                                                                                  | `functions/src/index.ts`     |
| **SEC-N04** | **Baja**  | `import axios from "axios"` en Cloud Functions no se usa (dead import).                                                                                                                                    | `functions/src/index.ts` L4  |
| **SEC-N05** | **Baja**  | Mezcla de `functions.config()` (deprecated) y `secrets` (v2) en Cloud Functions.                                                                                                                           | `functions/src/index.ts` L60 |

### 3.2 Arquitectura

| ID           | Severidad | Hallazgo                                                                                                                                                                               | Archivo                                          |
| ------------ | --------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------ |
| **ARCH-N01** | **Media** | `deletePayment` existe en `IDataService` + `FirebaseService` pero Firestore rules lo bloquean (`allow delete: if false`). Es código muerto que da una falsa expectativa al consumidor. | `IDataService.ts` L39, `FirebaseService.ts` L239 |
| **ARCH-N02** | **Media** | `addPayment` descarta silenciosamente el campo `date` del input y siempre escribe `Timestamp.now()` — violación del contrato de tipo.                                                  | `FirebaseService.ts` L232-236                    |
| **ARCH-N03** | **Media** | `subscribeToFinance` en `DataContext` descarta callback de unpaid appointments (`() => {}`) — listener Firestore activo que consume lecturas facturables sin beneficio.                | `DataContext.tsx` L89                            |
| **ARCH-N04** | **Media** | Task operations (`completeTask`, `updateTask`, `toggleSubtaskCompletion`) usan read-modify-write no atómico. Race conditions posibles en edición concurrente.                          | `FirebaseService.ts` L449-500                    |
| **ARCH-N05** | **Baja**  | `saveNote` no es atómica: primero guarda nota, luego actualiza `appointment.hasNotes` en operación separada. Si la segunda falla, queda desincronizado.                                | `FirebaseService.ts` L405-421                    |
| **ARCH-N06** | **Baja**  | Batch writes sin partición en `addRecurringAppointments` y `deleteRecurringSeries`. Firestore limita a 500 ops/batch — series anuales podrían exceder.                                 | `FirebaseService.ts` L186                        |
| **ARCH-N07** | **Baja**  | `setLoading(false)` en DataContext solo depende de `myAppointments` — patients y payments podrían no haber cargado aún.                                                                | `DataContext.tsx` L84                            |

### 3.3 Hooks y Componentes

| ID           | Severidad | Hallazgo                                                                                                                                                                | Archivo             |
| ------------ | --------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------- |
| **HOOK-N01** | **Media** | `useDataActions` no usa `useMemo`/`useCallback` — retorna ~16 funciones nuevas en cada render. Causa re-renders innecesarios si se pasan como props.                    | `useDataActions.ts` |
| **HOOK-N02** | **Media** | `useStaff` importa `serverTimestamp` directamente de `firebase/firestore` — rompe la abstracción `IDataService`. El timestamp debería generarse en la capa de servicio. | `useStaff.ts` L3    |
| **HOOK-N03** | **Baja**  | `usePatients` es un wrapper trivial que ignora su parámetro `_user` y solo devuelve `useData()`. Puede eliminarse.                                                      | `usePatients.ts`    |
| **HOOK-N04** | **Baja**  | `PSIQUE_RATE = 0.25` duplicada: declarada en `psiqueCalculations.ts`, redeclarada en `useAgendaStats.ts` L5, y también en `PaymentsView.tsx` L31.                       | Múltiples archivos  |
| **COMP-N01** | **Media** | `MobileHeader` le faltan 2 items que sí tiene `Sidebar`: "Estadísticas" está ausente y no tiene indicador de deudas pendientes (dot rojo).                              | `MobileHeader.tsx`  |
| **COMP-N02** | **Media** | `SidebarItem` tiene props tipadas como `: any`. Debería tener interfaz explícita.                                                                                       | `Sidebar.tsx` L90   |

### 3.4 Componentes Oversized (sin cambios desde auditoría previa)

| Componente                    | Líneas | Comentario                                                                         |
| ----------------------------- | ------ | ---------------------------------------------------------------------------------- |
| `AppointmentDetailsModal.tsx` | 806    | ↑ Creció desde 694. Notas clínicas, confirmaciones, cancelación deberían separarse |
| `TasksView.tsx`               | 649    | Similar al anterior. Modals inline + filtros + writes                              |
| `CalendarView.tsx`            | 632    | WeekView, MonthView, AppointmentCard deberían ser componentes separados            |
| `PaymentsView.tsx`            | 621    | 5 modos de vista deberían ser sub-componentes                                      |
| `PatientModal.tsx`            | 539    | Form state podría extraerse a `usePatientForm`                                     |
| `PatientHistoryView.tsx`      | 535    | Nuevo; tamaño considerable                                                         |

### 3.5 Duplicación de Código

| Patrón                           | Ocurrencias                                                                   | Cambio vs Auditoría | Estado                                                                                      |
| -------------------------------- | ----------------------------------------------------------------------------- | ------------------- | ------------------------------------------------------------------------------------------- |
| `calculateAge()`                 | 2 archivos (`PatientsView`, `PatientHistoryView`)                             | ↓ Mejoró (era 4)    | **Pendiente** — debería centralizarse en `utils.ts`                                         |
| `PSIQUE_RATE = 0.25`             | 3 archivos (`psiqueCalculations.ts`, `useAgendaStats.ts`, `PaymentsView.tsx`) | ↓ Mejoró (era 4+)   | **Pendiente** — `useAgendaStats` y `PaymentsView` deberían importar de `psiqueCalculations` |
| `isOverdue()`                    | 2 archivos (`DashboardView`, `PaymentsView`) con lógica diferente             | Sin cambio          | **Pendiente** — centralizar en utils                                                        |
| `toLocaleDateString()` variantes | ~15 usos con locales mixtos (`es-AR`, `es-ES`, default)                       | Sin cambio          | **Pendiente** — helpers de formateo en utils                                                |
| `signOut` import directo         | 2 archivos (`Sidebar`, `MobileHeader`)                                        | Aceptable           | OK — es auth, no data layer                                                                 |

### 3.6 Testing — Gaps Identificados

| Área            | Testeada                                   | Sin Tests                                                                                                                                             | Prioridad |
| --------------- | ------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------- | --------- |
| **Hooks**       | `useAgendaStats`, `usePendingTasks` (2/10) | `useBillingStatus`, `useCalendarAppointments`, `useClinicalNotes`, `useDataActions`, `usePatientData`, `usePatients`, `usePsiquePayments`, `useStaff` | Alta      |
| **Componentes** | 0/15+                                      | Todos. Ningún test de rendering.                                                                                                                      | Media     |
| **Vistas**      | 0/9                                        | Todas.                                                                                                                                                | Media     |
| **Contextos**   | 0/2                                        | `DataContext`, `ServiceContext`                                                                                                                       | Media     |
| **E2E flujos**  | Solo auth (1 archivo)                      | Crear paciente, agendar cita, pago, facturación                                                                                                       | Media     |
| **lib/**        | `utils.ts`, `psiqueCalculations.ts`        | `firebase.ts`, `routes.ts`, `constants.ts`                                                                                                            | Baja      |

### 3.7 Configuración

| Item                                   | Estado        | Detalle                                                                                                                                                                                                                                                                                             |
| -------------------------------------- | ------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `version: "0.0.0"` en package.json     | **Pendiente** | No sigue semver. El proyecto ya tuvo su primer lanzamiento en producción ("Initial Release") el 20 de febrero de 2026 y posee documentación de arquitectura en `v1.0.0_TECHNICAL.md`. Mantener `"0.0.0"` fue un descuido de despliegue ocurrido durante el Ciclo 1 que debe corregirse a `"1.0.0"`. |
| `engines` field en package.json        | **Ausente**   | No fija versión de Node requerida                                                                                                                                                                                                                                                                   |
| `noUncheckedIndexedAccess` en tsconfig | **Ausente**   | Accesos a arrays/records no validan `undefined`                                                                                                                                                                                                                                                     |
| `sourcemap: 'hidden'` en vite build    | **Ausente**   | Sin source maps para error tracking en producción                                                                                                                                                                                                                                                   |
| Tailwind semantic tokens               | **Ausente**   | `theme.extend` vacío; `teal-600` hardcodeado en componentes                                                                                                                                                                                                                                         |
| Path aliases (`@/`)                    | **Ausente**   | Imports con rutas relativas largas                                                                                                                                                                                                                                                                  |
| Playwright multi-browser               | Solo Chromium | Sin Firefox ni WebKit                                                                                                                                                                                                                                                                               |
| Playwright screenshots on failure      | **Ausente**   | Dificulta debugging de E2E en CI                                                                                                                                                                                                                                                                    |
| `vendor-react` chunk vacío             | Cosmético     | 0.03KB — React absorbido por `vendor-ui`. Funcional, no óptimo para cache                                                                                                                                                                                                                           |

### 3.8 ESLint Warnings (11)

Todos son `@typescript-eslint/no-explicit-any` + 1 `react-hooks/exhaustive-deps` + 2 `react-refresh/only-export-components`:

| Archivo                       | Warning                                | Tipo                          |
| ----------------------------- | -------------------------------------- | ----------------------------- |
| `Sidebar.tsx` L102            | `SidebarItem` props `: any`            | `no-explicit-any`             |
| `AppointmentModal.tsx` L235   | Select value `: any`                   | `no-explicit-any`             |
| `DataContext.tsx` L33         | Export no-component junto a componente | `react-refresh`               |
| `ServiceContext.tsx` L9       | Export no-component junto a componente | `react-refresh`               |
| `ServiceContext.tsx` L25      | `user` falta en deps de `useMemo`      | `react-hooks/exhaustive-deps` |
| `utils.test.ts` L26-27        | Test assertion con `: any` (2)         | `no-explicit-any`             |
| `IDataService.test.ts` L173   | Mock con `: any`                       | `no-explicit-any`             |
| `AuthScreen.tsx` L91          | `err: any` en catch                    | `no-explicit-any`             |
| `DashboardView.tsx` L71, L435 | `appointment: any`, icon prop (2)      | `no-explicit-any`             |

**Nota:** El warning de `react-hooks/exhaustive-deps` en `ServiceContext.tsx` L25 implica que el `useMemo` para crear `FirebaseService` potencialmente no se recalcula cuando cambia `user` — podría ser un bug sutil si `user` muta sin que cambie `user.uid`.

---

## 4. `firebase/firestore` IMPORTS FUERA DEL SERVICE LAYER

La auditoría original identificó 5+ hooks con acceso directo a Firestore. Estado actual:

| Import                                                               | Archivo                           | Justificación                                           | Veredicto            |
| -------------------------------------------------------------------- | --------------------------------- | ------------------------------------------------------- | -------------------- |
| `User` (type)                                                        | 12 archivos                       | Solo tipado — no acceso a datos                         | **Aceptable**        |
| `signOut`                                                            | `Sidebar.tsx`, `MobileHeader.tsx` | Auth operation — no data layer                          | **Aceptable**        |
| `signInWithEmailAndPassword`, `doc`, `getDoc`, `setDoc`, `Timestamp` | `AuthScreen.tsx`                  | Auth + onboarding — justificado                         | **Aceptable**        |
| `serverTimestamp`                                                    | `useStaff.ts`                     | **Operación de datos** que debería estar en el servicio | **Issue (HOOK-N02)** |

**Resultado:** Solo 1 hook (`useStaff`) tiene una violación real de la abstracción — mejora enorme respecto a los 7 archivos originales. Por este motivo, el hallazgo original **ARCH-01 no puede darse por 100% resuelto** hasta que la generación de `serverTimestamp` se mueva a `FirebaseService`.

---

## 5. CALIFICACIÓN POR ÁREA

### Seguridad: B (era D)

**Mejoras masivas:** RBAC completo, allowlist, Turnstile server-side, CSP limpia, cache headers, preconnect, noscript.

**Deuda restante:** `psiquePayments` sin RBAC (SEC-N01), storage rules sin límites (SEC-07), sin schema validation (SEC-06), sin audit trail (SEC-10), sin session timeout (SEC-11). La mayoría son mejoras deseables, no vulnerabilidades críticas.

### Arquitectura: B+ (era B)

**Mejoras:** Service layer funcionalmente completo, casi todos los hooks migrados, ErrorBoundary, StaffGate pattern, doble ServiceProvider para resolver dependencia circular.

**Deuda restante:** ARCH-01 parcialmente abierto (`useStaff` con import directo de Firebase), `deletePayment` muerto (ARCH-N01), `addPayment` descarta date (ARCH-N02), listener desperdiciado (ARCH-N03), task operations no atómicas (ARCH-N04), `saveNote` no atómica (ARCH-N05), batch sin partición (ARCH-N06), loading prematura (ARCH-N07). Son issues de coherencia y robustez, no de diseño fundamental.

### TypeScript: A- (era B+)

**Mejoras:** 0 errores de compilación, ESLint con reglas TypeScript, tipos de dominio completos con `BillingStatusData`, `AllowedEmail`, Input types.

**Deuda restante:** 11 warnings `no-explicit-any` (7 en código de producción, 4 en tests), `noUncheckedIndexedAccess` ausente, `ClinicalNoteInput` definido pero no usado, `PsiquePayment.professional` ausente del tipo.

### Testing: B- (era F)

**Mejoras espectaculares:** De 7 tests a 92. Coverage scope con thresholds enforced. Tests para FirebaseService (50), hooks de negocio (14), utils (7), psiqueCalculations (15), IDataService contract (6).

**Deuda restante:** 8/10 hooks sin tests, 0 tests de componentes/vistas, 0 tests de contextos, solo 1 E2E file. La estrategia de coverage scope progresivo es pragmática pero el coverage real del codebase total es ~25%.

### Performance: A- (era C+)

**Mejoras:** Bundle principal de 29.65KB (era 693KB), lazy loading de 9 vistas, chunks separados para vendors, date window dinámica con visibilitychange.

**Deuda restante:** `vendor-react` chunk redundante (cosmético), listener de finance desperdiciado (ARCH-N03), sin source maps para production debugging.

### Código: B (era C+)

**Mejoras:** Hooks refactorizados, constantes parcialmente centralizadas (`PSIQUE_RATE` en `psiqueCalculations.ts`), `calculateAge` reducido de 4 a 2 duplicaciones.

**Deuda restante:** 6 componentes con 500+ líneas, duplicación de `isOverdue`/`calculateAge`/date formatting, `useDataActions` sin memoización.

### Accesibilidad: B+ (era D)

**Mejoras:** `ModalOverlay` con implementación de a11y completa (role, aria-modal, aria-label, focus trap, Escape, focus restore).

**Deuda restante:** `MobileHeader` sin landmarks de a11y, `PatientTable` sin `aria-sort`, `DashboardView` sin labels en algunos controles.

### DX: A- (era C)

**Mejoras:** ESLint 9 + Prettier + `.env.example` + script `ci` + `.gitignore` actualizado + coverage thresholds + restoreMocks.

**Deuda restante:** Sin path aliases, sin `engines` field, `version: 0.0.0`, sin `screenshot: 'only-on-failure'` en Playwright.

---

## 6. PLAN DE ACCIÓN RECOMENDADO

### Prioridad Alta — Seguridad y Corrección

| #   | Acción                                                                                                        | Issue    | Esfuerzo |
| --- | ------------------------------------------------------------------------------------------------------------- | -------- | -------- |
| 1   | Restringir `psiquePayments` a admin en Firestore rules                                                        | SEC-N01  | 15 min   |
| 2   | Agregar límites de tamaño (10MB) y MIME type en `storage.rules`                                               | SEC-07   | 15 min   |
| 3   | Sanitizar `data` en `triggerInvoiceGeneration` — whitelist de campos permitidos                               | SEC-N02  | 30 min   |
| 4   | Eliminar `deletePayment` de `IDataService` y `FirebaseService` (código muerto)                                | ARCH-N01 | 15 min   |
| 5   | Fix `addPayment` para respetar `date` del input o documentar override explícitamente                          | ARCH-N02 | 15 min   |
| 6   | Implementar rate limiting y App Check en `validateTurnstile` — evita consumo malicioso de cuota de Cloudflare | SEC-N03  | 1-2h     |

### Prioridad Media — Calidad de Código y Arquitectura

| #   | Acción                                                                                                                                     | Issue         | Esfuerzo                    |
| --- | ------------------------------------------------------------------------------------------------------------------------------------------ | ------------- | --------------------------- |
| 7   | Centralizar `calculateAge`, `isOverdue`, date formatting helpers en `utils.ts`                                                             | HOOK-N04, DUP | 1h                          |
| 8   | Importar `PSIQUE_RATE` desde `psiqueCalculations.ts` en los archivos que lo redeclaran                                                     | HOOK-N04      | 15 min                      |
| 9   | Memoizar `useDataActions` con `useMemo` sobre el objeto retornado                                                                          | HOOK-N01      | 30 min                      |
| 10  | Mover `serverTimestamp` de `useStaff` a `createStaffProfile` en `FirebaseService` (cierra ARCH-01)                                         | HOOK-N02      | 30 min                      |
| 11  | Agregar paridad de features en `MobileHeader` (Estadísticas + indicador de deuda)                                                          | COMP-N01      | 30 min                      |
| 12  | Tipar `SidebarItem` props explícitamente                                                                                                   | COMP-N02      | 10 min                      |
| 13  | Eliminar `usePatients` wrapper                                                                                                             | HOOK-N03      | 15 min + actualizar imports |
| 14  | Mapear errores Firebase a mensajes user-friendly en catch general de AuthScreen                                                            | SEC-13        | 30 min                      |
| 15  | Eliminar listener `subscribeToFinance` desperdiciado en `DataContext` (`() => {}` descarta datos — lecturas Firestore sin beneficio)       | ARCH-N03      | 30 min                      |
| 16  | Refactorizar operaciones de Task (`completeTask`, `updateTask`, `toggleSubtaskCompletion`) para que sean atómicas y evitar race conditions | ARCH-N04      | 1h                          |
| 17  | Implementar mecanismo de session timeout para Firebase Auth                                                                                | SEC-11        | 2h                          |
| 18  | Registrar audit trail para accesos a datos clínicos (colección `auditLogs` o Cloud Function)                                               | SEC-10        | 3-4h                        |

### Prioridad Media — Testing

| #   | Acción                                                                                   | Issue     | Esfuerzo |
| --- | ---------------------------------------------------------------------------------------- | --------- | -------- |
| 19  | Tests para `usePsiquePayments`, `useBillingStatus`, `useClinicalNotes`, `useDataActions` | TEST gaps | 4-6h     |
| 20  | Tests de rendering básicos para componentes críticos (ModalOverlay, PatientCard)         | TEST gaps | 2-3h     |
| 21  | Ampliar E2E: flujo de crear paciente → agendar cita → registrar pago                     | TEST gaps | 3-4h     |

### Prioridad Baja — Polish y Mejoras Menores

| #   | Acción                                                                                                  | Issue    | Esfuerzo     |
| --- | ------------------------------------------------------------------------------------------------------- | -------- | ------------ |
| 22  | Agregar schema validation mínima en Firestore rules                                                     | SEC-06   | 2-3h         |
| 23  | Agregar `noUncheckedIndexedAccess` a tsconfig                                                           | Config   | 1-2h (fixes) |
| 24  | Configurar path aliases (`@/`) en tsconfig + Vite                                                       | Config   | 30 min       |
| 25  | Agregar `sourcemap: 'hidden'` en vite.config.ts                                                         | Config   | 5 min        |
| 26  | Definir semantic tokens en Tailwind (`brand.primary`, `brand.secondary`)                                | Config   | 1h           |
| 27  | Actualizar `version` a `1.0.0` + agregar campo `engines` (descuido de despliegue Ciclo 1)               | Config   | 5 min        |
| 28  | Refactorizar componentes grandes (AppointmentDetailsModal, CalendarView, TasksView)                     | Código   | 8-12h        |
| 29  | Eliminar `axios` dead import en Cloud Functions                                                         | SEC-N04  | 2 min        |
| 30  | Migrar `functions.config()` a `defineString()` en Cloud Functions                                       | SEC-N05  | 30 min       |
| 31  | Agregar `screenshot: 'only-on-failure'` en Playwright config                                            | Config   | 5 min        |
| 32  | Hacer atómica la operación `saveNote` (guardar nota + actualizar `hasNotes` en un batch)                | ARCH-N05 | 1h           |
| 33  | Particionar batch writes en `addRecurringAppointments` / `deleteRecurringSeries` (límite 500 ops/batch) | ARCH-N06 | 1h           |
| 34  | Corregir dependencias de `setLoading(false)` en `DataContext` para esperar a `patients` y `payments`    | ARCH-N07 | 15 min       |

---

## 7. CONCLUSIÓN

El proyecto pasó de un **C+** con hallazgos críticos de seguridad a un **B+** sólido en solo 7 días (4 fases de mejora). 11 de los 12 hallazgos originales marcados como críticos están resueltos; ARCH-01 se cierra en un **95%** (pendiente de mover `serverTimestamp` de `useStaff` a `FirebaseService`, ítem 10 del plan). La deuda técnica restante consiste en:

- **4 issues de seguridad media** (psiquePayments RBAC, storage limits, data sanitization, rate limiting Turnstile)
- **7 issues de arquitectura** (código muerto, listener desperdiciado, task ops no atómicas, saveNote no atómica, batch sin partición, loading prematura, ARCH-01 residual)
- **6 issues de código media** (memoización, duplicación, paridad mobile)
- **Gaps de testing significativos** (8/10 hooks, 0/15 componentes, 0/9 vistas sin tests)
- **Configuración menor** (path aliases, semver, semantic tokens)
- **2 issues de seguridad previamente omitidos del plan** (SEC-10 audit trail, SEC-11 session timeout) ahora incorporados

Ninguno de estos bloquea la operación ni representa un riesgo crítico. El plan actualizado prioriza correcciones rápidas de seguridad (ítems 1-6, ~2.5h), luego calidad de código y arquitectura (ítems 7-18, ~8h), testing (ítems 19-21, ~10h) y polish (ítems 22-34, ~17h).

---

#### _Auditoría realizada por GitHub Copilot (Claude Opus 4.6) — 26 de febrero de 2026_

---

## Planes generados a partir de esta auditoría

| Plan | Hallazgos abordados | Estado                     |
| ---- | ------------------- | -------------------------- |
| —    | —                   | Pendiente de planificación |

→ Auditoría previa: [`docs/audits/2026-02-19_AUDIT.md`](2026-02-19_AUDIT.md)

→ Índice general: [`docs/README.md`](../README.md)
