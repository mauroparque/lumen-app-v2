# Lumen Salud Mental - Documentación Técnica

**Versión:** 1.0.0  
**Fecha:** 2026-02-22  
**Stack:** React 18 + TypeScript + Vite + Firebase + TailwindCSS

---

## Arquitectura General

```text
┌─────────────────────────────────────────────────────────────┐
│                         Frontend                            │
│  React 18 + TypeScript + Vite + TailwindCSS + PWA           │
├─────────────────────────────────────────────────────────────┤
│                         Backend                             │
│  Firebase (Auth + Firestore + Cloud Functions)              │
└─────────────────────────────────────────────────────────────┘
```

---

## Estructura del Proyecto

```bash
src/
├── App.tsx                           # Punto de entrada, routing de vistas
├── main.tsx                          # Bootstrap de React
├── index.css                         # Estilos globales
├── types/index.ts                    # Interfaces TypeScript
│
├── views/                            # Vistas principales
│   ├── AuthScreen.tsx                # Login/Registro (con Cloudflare Turnstile)
│   ├── DashboardView.tsx             # Panel principal
│   ├── CalendarView.tsx              # Agenda/Calendario
│   ├── PatientsView.tsx              # Gestión de pacientes
│   ├── PatientHistoryView.tsx        # Historial clínico
│   ├── PaymentsView.tsx              # Pagos y proyección
│   ├── BillingView.tsx               # Facturación
│   ├── TasksView.tsx                 # Gestión de tareas
│   └── StatisticsView.tsx            # Estadísticas de agenda
│
├── components/
│   ├── layout/                       # Sidebar, MobileHeader
│   ├── modals/                       # Modales
│   │   ├── AddTaskModal.tsx
│   │   ├── AppointmentDetailsModal.tsx
│   │   ├── AppointmentModal.tsx
│   │   ├── PatientModal.tsx
│   │   ├── PatientProfileModal.tsx
│   │   ├── PaymentModal.tsx
│   │   └── ProfileModal.tsx
│   ├── drawers/                      # Drawers laterales (vacío, reservado)
│   ├── patients/                     # PatientTable, PatientCard
│   ├── payments/                     # IncomeProjection
│   ├── ui/                           # Componentes UI base (LoadingSpinner, ModalOverlay)
│   └── PWAUpdatePrompt.tsx           # Prompt de actualización PWA
│
├── hooks/                            # Custom hooks
│   ├── useAgendaStats.ts             # Estadísticas de agenda
│   ├── useBillingStatus.ts           # Estado de facturación
│   ├── useCalendarAppointments.ts    # Turnos para vista calendario
│   ├── useClinicalNotes.ts           # Notas clínicas por paciente
│   ├── useDataActions.ts             # CRUD centralizado
│   ├── usePatientData.ts             # Historial y pagos por paciente
│   ├── usePatients.ts                # Lista de pacientes filtrada
│   ├── usePendingTasks.ts            # Tareas pendientes globales
│   ├── usePsiquePayments.ts          # Pagos mensuales a Psique
│   └── useStaff.ts                   # Perfiles del staff
│
├── context/                          # React Context
│   ├── DataContext.tsx               # Patients, Appointments, Payments
│   └── ServiceContext.tsx            # Firebase service injection
│
├── services/
│   ├── IDataService.ts               # Interface
│   └── FirebaseService.ts            # Implementación Firestore
│
└── lib/
    ├── firebase.ts                   # Configuración Firebase
    ├── constants.ts                  # Constantes de dominio
    ├── routes.ts                     # Rutas de colecciones Firestore
    └── utils.ts                      # cn() y utilidades
```

---

## Modelos de Datos

### Tipos auxiliares

```typescript
type View = 'home' | 'dashboard' | 'calendar' | 'patients' | 'payments' | 'billing' | 'patient-history' | 'tasks' | 'statistics';
type ContactRelationship = 'padre' | 'madre' | 'amigo' | 'pareja' | 'otro';
```

### Patient

```typescript
interface Patient {
  id: string;
  name: string;                    // Nombre completo o computado
  firstName?: string;
  lastName?: string;
  dni?: string;
  email: string;
  phone: string;
  fee?: number;                    // Honorario por sesión
  preference?: 'presencial' | 'online';
  office?: string;                 // Consultorio asignado
  professional?: string;
  isActive: boolean;
  birthDate?: string;              // YYYY-MM-DD
  admissionDate?: string;          // YYYY-MM-DD
  dischargeType?: 'clinical' | 'dropout';
  dischargeDate?: string;
  patientSource?: 'psique' | 'particular';
  // Contacto para menores
  contactName?: string;
  contactPhone?: string;
  contactRelationship?: ContactRelationship;
  contactRelationshipOther?: string; // Si el vínculo es 'otro'
}
```

### Appointment

```typescript
interface Appointment {
  id: string;
  patientId: string;
  patientName: string;
  patientEmail?: string;
  date: string;                    // YYYY-MM-DD
  time: string;                    // HH:mm
  duration: number;                // minutos
  type: 'presencial' | 'online';
  meetLink?: string;               // Link custom de videollamada
  status: 'programado' | 'completado' | 'cancelado' | 'ausente' | 'presente';
  chargeOnCancellation?: boolean;  // Cobra aunque cancele
  isPaid?: boolean;
  price?: number;
  professional?: string;
  office?: string;                 // Consultorio
  hasNotes?: boolean;              // Indica si hay nota clínica asociada
  consultationType?: string;
  excludeFromPsique?: boolean;     // Excluir del cálculo Psique 25%
  // Google Calendar
  googleEventId?: string;
  googleMeetLink?: string;
  // Recurrencia
  recurrenceId?: string;
  recurrenceIndex?: number;
  recurrenceRule?: string;
  // Facturación
  billingStatus?: 'pending' | 'requested' | 'invoiced';
  invoiceRequestId?: string;       // Referencia al request de facturación
}
```

### Payment

```typescript
interface Payment {
  id: string;
  appointmentId?: string;
  patientId?: string;
  patientName: string;
  amount: number;
  date: Timestamp | null;
  concept: string;
}
```

### StaffProfile

```typescript
interface StaffProfile {
  uid: string;
  email: string;
  name: string;
  role: 'admin' | 'professional' | 'secretary';
  specialty?: string;
  color?: string;                  // Color de identificación en agenda
  createdAt: Timestamp;
}
```

### ClinicalNote

```typescript
interface ClinicalNote {
  id: string;
  patientId: string;
  appointmentId: string;
  content: string;
  attachments: string[];
  tasks?: TaskItem[];
  createdAt: Timestamp;
  updatedAt?: Timestamp;
  createdBy: string;
  createdByUid: string;            // UID del autor — reglas de acceso Firestore
}

interface TaskItem {
  text: string;
  completed: boolean;
  subtasks?: TaskSubitem[];
}

interface TaskSubitem {
  text: string;
  completed: boolean;
}
```

### PsiquePayment

```typescript
interface PsiquePayment {
  id: string;
  month: string;                   // YYYY-MM
  totalAmount: number;
  isPaid: boolean;
  paidDate?: string;               // YYYY-MM-DD
}
```

### AllowedEmail (allowlist)

```typescript
interface AllowedEmail {
  email: string;
  role: 'admin' | 'professional';
  professionalName: string;
}
```

---

## Funcionalidades Principales

### 1. Gestión de Pacientes

- CRUD completo de pacientes
- Filtros: activo/inactivo, fuente (Psique/Particular)
- Historial clínico con notas y tareas

### 2. Agenda/Calendario

- Vista mensual con turnos
- Creación de turnos individuales y recurrentes
- Estados: programado, presente, ausente, cancelado, completado
- Integración Google Calendar (opcional)

### 3. Sistema de Pagos

- **Vencidos**: Turnos pasados sin pagar
- **Próximos**: Turnos futuros a cobrar
- **Historial**: Pagos realizados
- **Psique**: Gestión del 25% a pagar a Psique Salud Mental
- **Proyección**: Estimación de ingresos del próximo mes

### 4. Descuento Psique

- Pacientes con `patientSource: 'psique'` tienen 25% de descuento
- Cada turno puede excluirse individualmente (`excludeFromPsique`)
- Se muestra bruto/neto en todos los listados

### 5. Estadísticas de Agenda

Calculadas sobre los últimos 3 meses:

- Promedio de sesiones por paciente
- Honorario promedio
- Valor real por sesión
- Tasa de ausentismo
- Tasa de cancelación
- Top 10 pacientes por sesiones

### 6. Facturación

- Generación de facturas vía webhook a n8n
- Estados: pending → processing → completed/error

### 7. Tareas Clínicas

- Tareas asociadas a pacientes
- Subtareas con checkbox
- Vista global de tareas pendientes

---

## IDataService (Interface de servicio)

Abstracción sobre Firestore. `FirebaseService` es la única implementación. Todos los métodos de mutación son promesas; las lecturas son suscripciones en tiempo real con callback.

```typescript
interface IDataService {
  // Suscripciones en tiempo real
  subscribeToPatients(onData: (data: Patient[]) => void): () => void;
  subscribeToAppointments(start: string, end: string, onData: (data: Appointment[]) => void): () => void;
  subscribeToMyAppointments(start: string, end: string, onData: (data: Appointment[]) => void): () => void;
  subscribeToFinance(onUnpaid: (data: Appointment[]) => void, onPayments: (data: Payment[]) => void): () => void;

  // Pacientes
  addPatient(patient: PatientInput): Promise<string>;
  updatePatient(id: string, data: Partial<Patient>): Promise<void>;
  deletePatient(id: string): Promise<void>;

  // Turnos
  addAppointment(appointment: AppointmentInput): Promise<string>;
  addRecurringAppointments(base: AppointmentInput, dates: string[], recurrenceRule?: string): Promise<void>;
  updateAppointment(id: string, data: Partial<Appointment>): Promise<void>;
  deleteAppointment(id: string): Promise<void>;
  deleteRecurringSeries(recurrenceId: string): Promise<number>;
  deleteRecurringFromDate(recurrenceId: string, fromDate: string): Promise<number>;

  // Pagos
  addPayment(payment: PaymentInput, appointmentId?: string): Promise<string>;
  updatePayment(id: string, data: Partial<Payment>): Promise<void>;
  deletePayment(id: string): Promise<void>;

  // Facturación
  requestBatchInvoice(appointments: Appointment[], patientData: PatientBillingData): Promise<string>;
}
```

---

## Hooks Principales

### `useAgendaStats`

Calcula estadísticas de los últimos 3 meses:

```typescript
const stats = useAgendaStats(appointments, patients);
// stats.avgSessionsPerPatient, stats.noShowRate, etc.
```

### `usePsiquePayments`

Gestiona el pago mensual a Psique:

```typescript
const { monthData, markAsPaid } = usePsiquePayments(appointments, patients, date);
```

### `useDataActions`

CRUD centralizado con guard de disponibilidad del servicio:

```typescript
const { 
  addPatient, updatePatient, deletePatient,
  addAppointment, updateAppointment, deleteAppointment,
  addRecurringAppointments, deleteRecurringSeries, deleteRecurringFromDate,
  addPayment, updatePayment, deletePayment,
  requestBatchInvoice
} = useDataActions();
```

### `usePatientData`

Historial completo de un paciente (turnos + pagos) con estadísticas derivadas:

```typescript
const { history, payments, loading, stats } = usePatientData(user, patientId);
// stats.totalDebt, stats.totalPaid, stats.lastVisit
```

### `useClinicalNotes`

Notas clínicas asociadas a un turno o paciente.

### `useBillingStatus`

Estado de facturación de turnos (pending / requested / invoiced).

### `useStaff`

Perfiles del staff de la clínica (multiprofesional).

### `usePendingTasks`

Agregado de tareas clínicas pendientes en todos los pacientes.

### `useCalendarAppointments`

Turnos del mes seleccionado para la vista calendario.

---

## Colecciones Firestore

Todas bajo `artifacts/{appId}/clinics/{CLINIC_ID}/`:

| Colección | Descripción |
| --- | --- |
| `patients` | Pacientes de la clínica |
| `appointments` | Turnos (filtrados por profesional en queries) |
| `payments` | Pagos registrados |
| `staff` | Perfiles del equipo (auth + roles) |
| `allowedEmails` | Lista blanca para onboarding de nuevos usuarios |
| `notes` | Notas clínicas por turno |
| `psiquePayments` | Registros mensuales de pago a Psique Salud Mental |
| `integrations/billing/queue/{id}` | Cola de solicitudes de facturación (write-once) |

## Seguridad (Firestore Rules)

RBAC con roles `admin` / `professional` / `secretary`. El rol se obtiene desde `/staff/{uid}` en cada evaluación.

```javascript
// Staff — admin CRUD; profesional crea y lee el propio (onboarding)
match /staff/{userId} {
  allow read: if isAuthenticated() && (isAdmin() || request.auth.uid == userId);
  allow create: if isAuthenticated() && (isAdmin() || request.auth.uid == userId);
  allow update, delete: if isAuthenticated() && isAdmin();
}

// Allowlist — solo admins
match /allowedEmails/{emailId} {
  allow read, write: if isAuthenticated() && isAdmin();
}

// Pacientes — admin CRUD; profesional CRUD propios + lectura de otros
match /patients/{patientId} {
  allow read: if isAuthenticated();
  allow create: if isAuthenticated() && (isAdmin() || request.resource.data.professional == getProfessionalName());
  allow update, delete: if isAuthenticated() && (isAdmin() || resource.data.professional == getProfessionalName());
}

// Turnos — admin CRUD; profesional CRUD propios + lectura de otros
// Protección de facturados: solo isPaid editable cuando billingStatus == 'invoiced'
match /appointments/{appointmentId} {
  allow read: if isAuthenticated();
  allow create: if isAuthenticated() && (isAdmin() || ...);
  allow delete: if isAuthenticated() && isNotInvoiced() && (isAdmin() || ...);
  allow update: if isAuthenticated() && (isNotInvoiced() ||
    request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isPaid']));
}

// Pagos — lectura, creación y edición; delete bloqueado para todos
match /payments/{paymentId} {
  allow read, create: if isAuthenticated();
  allow update: if isAuthenticated() && (isAdmin() || resource.data.professional == getProfessionalName());
  allow delete: if false;
}

// Notas clínicas — solo creador o admin pueden leer/editar/borrar
match /notes/{noteId} {
  allow read: if isAuthenticated() && (isAdmin() || resource.data.createdByUid == request.auth.uid);
  allow create: if isAuthenticated() && request.resource.data.createdByUid == request.auth.uid;
  allow update: if isAuthenticated() && (isAdmin() || resource.data.createdByUid == request.auth.uid)
    // createdByUid y createdBy son inmutables
    && request.resource.data.createdByUid == resource.data.createdByUid;
  allow delete: if isAuthenticated() && (isAdmin() || resource.data.createdByUid == request.auth.uid);
}

// Billing queue — write-once (no update/delete)
match /integrations/billing/queue/{requestId} {
  allow read, create: if isAuthenticated();
  allow update, delete: if false;
}

// Psique payments
match /psiquePayments/{monthId} {
  allow read, write: if isAuthenticated();
}
```

---

## PWA

Configurado con `vite-plugin-pwa`:

- Service Worker con Workbox
- Precaching de assets
- Prompt de actualización manual

---

## Scripts

```bash
npm run dev      # Desarrollo
npm run build    # Build producción
npm run preview  # Preview del build
npm test         # Unit tests (Vitest)
npm run test:ui  # Vitest con UI interactiva en browser
npm run test:e2e # E2E con Playwright

# Firebase
firebase deploy --only firestore:rules
firebase deploy --only hosting
```

---

## Dependencias Principales

| Paquete | Versión | Uso |
| --------- | --------- | ----- |
| react | 18.2.0 | UI Framework |
| firebase | ^10.8.0 | Backend (Auth, Firestore) |
| lucide-react | ^0.344.0 | Íconos |
| tailwindcss | ^3.4.19 | Estilos |
| sonner | ^2.0.7 | Notificaciones toast |
| vite-plugin-pwa | ^1.2.0 | PWA support |
| @marsidev/react-turnstile | ^1.4.0 | Cloudflare Turnstile (anti-bot en login) |
| clsx + tailwind-merge | ^2.1.1 / ^3.4.0 | Utility `cn()` para clases condicionales |

### DevDependencies relevantes

| Paquete | Versión | Uso |
| --------- | --------- | ----- |
| vitest | ^4.0.16 | Unit testing |
| @playwright/test | ^1.57.0 | E2E testing |
| @testing-library/react | ^16.3.1 | Component testing |
| jsdom | ^27.4.0 | Entorno DOM para Vitest |
