# Lumen Salud Mental - Documentación Técnica

**Versión:** 1.0.0  
**Fecha:** 2025-12-19  
**Stack:** React 18 + TypeScript + Vite + Firebase + TailwindCSS

---

## Arquitectura General

```
┌─────────────────────────────────────────────────────────────┐
│                         Frontend                            │
│  React 18 + TypeScript + Vite + TailwindCSS + PWA          │
├─────────────────────────────────────────────────────────────┤
│                         Backend                             │
│  Firebase (Auth + Firestore + Cloud Functions)              │
└─────────────────────────────────────────────────────────────┘
```

---

## Estructura del Proyecto

```
src/
├── App.tsx                 # Punto de entrada, routing de vistas
├── main.tsx               # Bootstrap de React
├── index.css              # Estilos globales
├── types/index.ts         # Interfaces TypeScript
│
├── views/                 # Vistas principales
│   ├── AuthScreen.tsx     # Login/Registro
│   ├── DashboardView.tsx  # Panel principal
│   ├── CalendarView.tsx   # Agenda/Calendario
│   ├── PatientsView.tsx   # Gestión de pacientes
│   ├── PatientHistoryView # Historial clínico
│   ├── PaymentsView.tsx   # Pagos y proyección
│   ├── BillingView.tsx    # Facturación
│   ├── TasksView.tsx      # Gestión de tareas
│   └── StatisticsView.tsx # Estadísticas de agenda
│
├── components/
│   ├── layout/            # Sidebar, MobileHeader
│   ├── modals/            # Modales (Patient, Appointment, Payment, etc.)
│   ├── patients/          # PatientTable, PatientCard
│   ├── payments/          # IncomeProjection
│   └── ui/                # Componentes UI base
│
├── hooks/                 # Custom hooks
│   ├── useAgendaStats.ts  # Estadísticas de agenda
│   ├── useCalendarAppointments.ts
│   ├── useClinicalNotes.ts
│   ├── useDataActions.ts  # CRUD operations
│   ├── usePatients.ts
│   ├── usePendingTasks.ts
│   ├── usePsiquePayments.ts
│   ├── useStaff.ts
│   └── useBillingStatus.ts
│
├── context/               # React Context
│   ├── DataContext.tsx    # Patients, Appointments, Payments
│   └── ServiceContext.tsx # Firebase service injection
│
├── services/
│   ├── IDataService.ts    # Interface
│   └── FirebaseService.ts # Implementación Firestore
│
└── lib/
    ├── firebase.ts        # Configuración Firebase
    └── routes.ts          # Rutas de colecciones Firestore
```

---

## Modelos de Datos

### Patient
```typescript
interface Patient {
  id: string;
  name: string;
  firstName?: string;
  lastName?: string;
  dni?: string;
  email: string;
  phone: string;
  fee?: number;                    // Honorario por sesión
  preference?: 'presencial' | 'online';
  professional?: string;
  isActive: boolean;
  birthDate?: string;              // YYYY-MM-DD
  admissionDate?: string;          // YYYY-MM-DD
  dischargeType?: 'clinical' | 'dropout';
  dischargeDate?: string;
  patientSource?: 'psique' | 'particular';
  // Contacto para menores
  contactName?: string;
  contactPhone?: string;
  contactRelationship?: ContactRelationship;
}
```

### Appointment
```typescript
interface Appointment {
  id: string;
  patientId: string;
  patientName: string;
  date: string;                    // YYYY-MM-DD
  time: string;                    // HH:mm
  duration: number;                // minutos
  type: 'presencial' | 'online';
  status: 'programado' | 'completado' | 'cancelado' | 'ausente' | 'presente';
  chargeOnCancellation?: boolean;  // Cobra aunque cancele
  isPaid?: boolean;
  price?: number;
  professional?: string;
  consultationType?: string;
  excludeFromPsique?: boolean;     // Excluir del cálculo Psique
  // Recurrencia
  recurrenceId?: string;
  recurrenceIndex?: number;
  recurrenceRule?: string;
  // Facturación
  billingStatus?: 'pending' | 'requested' | 'invoiced';
}
```

### Payment
```typescript
interface Payment {
  id: string;
  appointmentId?: string;
  patientId?: string;
  patientName: string;
  amount: number;
  date: Timestamp;
  concept: string;
}
```

---

## Funcionalidades Principales

### 1. Gestión de Pacientes
- CRUD completo de pacientes
- Filtros: activo/inactivo, fuente (Psique/Particular)
- Historial clínico con notas y tareas

### 2. Agenda/Calendario
- Vista mensual con turnos
- Creación de turnos individuales y recurrentes
- Estados: programado, presente, ausente, cancelado, completado
- Integración Google Calendar (opcional)

### 3. Sistema de Pagos
- **Vencidos**: Turnos pasados sin pagar
- **Próximos**: Turnos futuros a cobrar
- **Historial**: Pagos realizados
- **Psique**: Gestión del 25% a pagar a Psique Salud Mental
- **Proyección**: Estimación de ingresos del próximo mes

### 4. Descuento Psique
- Pacientes con `patientSource: 'psique'` tienen 25% de descuento
- Cada turno puede excluirse individualmente (`excludeFromPsique`)
- Se muestra bruto/neto en todos los listados

### 5. Estadísticas de Agenda
Calculadas sobre los últimos 3 meses:
- Promedio de sesiones por paciente
- Honorario promedio
- Valor real por sesión
- Tasa de ausentismo
- Tasa de cancelación
- Top 10 pacientes por sesiones

### 6. Facturación
- Generación de facturas vía webhook a n8n
- Estados: pending → processing → completed/error

### 7. Tareas Clínicas
- Tareas asociadas a pacientes
- Subtareas con checkbox
- Vista global de tareas pendientes

---

## Hooks Principales

### `useAgendaStats`
Calcula estadísticas de los últimos 3 meses:
```typescript
const stats = useAgendaStats(appointments, patients);
// stats.avgSessionsPerPatient, stats.noShowRate, etc.
```

### `usePsiquePayments`
Gestiona el pago mensual a Psique:
```typescript
const { monthData, markAsPaid } = usePsiquePayments(appointments, patients, date);
```

### `useDataActions`
CRUD centralizado:
```typescript
const { 
  addPatient, updatePatient, 
  addAppointment, updateAppointment,
  addPayment, updatePayment
} = useDataActions();
```

---

## Seguridad (Firestore Rules)

```javascript
// Pacientes, Staff, Notes: lectura/escritura autenticada
match /patients/{id} { allow read, write: if isAuthenticated(); }

// Appointments: protección de facturados
match /appointments/{id} {
  allow update: if isAuthenticated() && (
    isNotInvoiced() || 
    request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isPaid'])
  );
}

// Payments: lectura, creación y edición; no eliminación
match /payments/{id} { 
  allow read, create, update: if isAuthenticated(); 
  allow delete: if false; 
}
```

---

## PWA

Configurado con `vite-plugin-pwa`:
- Service Worker con Workbox
- Precaching de assets
- Prompt de actualización manual

---

## Scripts

```bash
npm run dev      # Desarrollo
npm run build    # Build producción
npm run preview  # Preview del build

# Firebase
firebase deploy --only firestore:rules
firebase deploy --only hosting
```

---

## Dependencias Principales

| Paquete | Versión | Uso |
|---------|---------|-----|
| react | 18.2.0 | UI Framework |
| firebase | 10.8.0 | Backend (Auth, Firestore) |
| lucide-react | 0.344.0 | Íconos |
| tailwindcss | 3.4.19 | Estilos |
| sonner | 2.0.7 | Notificaciones toast |
| vite-plugin-pwa | 1.2.0 | PWA support |
