rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthenticated() { return request.auth != null; }

    match /artifacts/{appId}/clinics/{clinicId} {

      function getStaffData() {
        return get(/databases/$(database)/documents/artifacts/$(appId)/clinics/$(clinicId)/staff/$(request.auth.uid)).data;
      }
      function isAdmin() { return getStaffData().role == 'admin'; }
      function getProfessionalName() { return getStaffData().name; }

      // Allowlist — solo admins pueden gestionar
      match /allowedEmails/{emailId} {
        allow read, write: if isAuthenticated() && isAdmin();
      }

      // Staff — admin CRUD, profesional crea su propio doc (onboarding) y lee el propio
      match /staff/{userId} {
        allow read: if isAuthenticated() && (isAdmin() || request.auth.uid == userId);
        allow create: if isAuthenticated() && (isAdmin() || request.auth.uid == userId);
        allow update, delete: if isAuthenticated() && isAdmin();
      }

      // Pacientes — admin CRUD, profesional CRUD propios + lectura de otros
      match /patients/{patientId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && (isAdmin() || request.resource.data.professional == getProfessionalName());
        allow update, delete: if isAuthenticated() && (isAdmin() || resource.data.professional == getProfessionalName());
      }

      // Turnos — admin CRUD, profesional CRUD propios + lectura de otros
      function isNotInvoiced() {
        return resource.data.get('billingStatus', 'pending') != 'invoiced';
      }
      match /appointments/{appointmentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && (isAdmin() || request.resource.data.professional == getProfessionalName());
        allow delete: if isAuthenticated() && isNotInvoiced() && (isAdmin() || resource.data.professional == getProfessionalName());
        allow update: if isAuthenticated() && (
          isAdmin() || resource.data.professional == getProfessionalName()
        ) && (
          isNotInvoiced() ||
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isPaid'])
        );
      }

      // Pagos — admin CRU, profesional CRU propios + lectura de otros; delete bloqueado
      match /payments/{paymentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated() && (isAdmin() || resource.data.get('professional', '') == getProfessionalName());
        allow delete: if false;
      }

      // Billing queue — admin y owner pueden crear; no update/delete
      match /integrations/billing/queue/{requestId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if false;
      }

      // Notas clínicas — lectura abierta (filtrado por contexto en frontend),
      // escritura restringida a creador o admin.
      // TODO Phase 2: agregar where('createdByUid', '==', uid) en queries y endurecer read rule
      match /notes/{noteId} {
        allow read: if isAuthenticated() && (isAdmin() || resource.data.createdByUid == request.auth.uid);
        allow create: if isAuthenticated() && request.resource.data.createdByUid == request.auth.uid;
        allow update: if isAuthenticated()
          && (isAdmin() || resource.data.createdByUid == request.auth.uid)
          && request.resource.data.createdByUid == resource.data.createdByUid
          && request.resource.data.createdBy == resource.data.createdBy;
        allow delete: if isAuthenticated() && (isAdmin() || resource.data.createdByUid == request.auth.uid);
      }

      // Psique payments — admin CRUD, profesional CRUD (billing propio)
      match /psiquePayments/{monthId} {
        allow read, write: if isAuthenticated();
      }
    }

    // Deny everything else
    match /{document=**} { allow read, write: if false; }
  }
}
