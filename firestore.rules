rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthenticated() { return request.auth != null; }
    function isNotInvoiced() { 
       return resource.data.get('billingStatus', 'pending') != 'invoiced'; 
    }
    match /artifacts/{appId}/clinics/{clinicId} {
      match /patients/{patientId} { allow read, write: if isAuthenticated(); }
      
      // REGLA CRÍTICA CORREGIDA:
      match /appointments/{appointmentId} {
        allow read, create: if isAuthenticated();
        allow delete: if isAuthenticated() && isNotInvoiced(); // Solo borrar si NO está facturado
        allow update: if isAuthenticated() && (
          isNotInvoiced() || // Si no está facturado, edita lo que quieras
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isPaid']) // Si ESTÁ facturado, solo deja cambiar isPaid
        );
      }
      
      match /payments/{paymentId} { allow read, create, update: if isAuthenticated(); allow delete: if false; }
      match /integrations/billing/queue/{requestId} { allow read: if isAuthenticated(); allow create: if isAuthenticated(); allow update, delete: if false; }
      match /staff/{userId} { allow read, write: if isAuthenticated(); }
      match /notes/{noteId} { allow read, write: if isAuthenticated(); }
      match /psiquePayments/{monthId} { allow read, write: if isAuthenticated(); }
    }
    match /{document=**} { allow read, write: if false; }
  }
}
